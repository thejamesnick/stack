STACK - WALLET & APPROVAL ARCHITECTURE
=======================================

IMPORTANT CLARIFICATION!
========================

FID vs WALLET ADDRESS:
----------------------

FID (Farcaster ID):
- Your IDENTITY across all platforms
- Stays the same everywhere
- Links to your profile, stats, achievements
- Stored in database as primary key

WALLET ADDRESS:
- Where your MONEY lives
- Can be DIFFERENT depending on platform:
  * Farcaster app â†’ Farcaster wallet address
  * Base app â†’ Coinbase Wallet address
  * Web â†’ MetaMask/WalletConnect address
- You can have MULTIPLE wallets linked to ONE FID
- Each wallet can fund different stacks


================================================================================
HOW IT WORKS
================================================================================

SCENARIO 1: User in Farcaster App
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Auto-get FID (e.g., FID: 12345)
2. User connects Farcaster wallet (0xABC...123)
3. Create stack "Summer Trip"
4. User approves USDC spending from 0xABC...123
5. Stack contract can now pull from 0xABC...123

Database:
- FID: 12345
- Wallet: 0xABC...123 (linked to FID 12345)
- Stack: "Summer Trip" (funded by 0xABC...123)


SCENARIO 2: Same User in Base App
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Auto-get FID (same FID: 12345)
2. User connects Coinbase Wallet (0xDEF...456) - DIFFERENT wallet!
3. Create stack "Emergency Fund"
4. User approves USDC spending from 0xDEF...456
5. Stack contract can now pull from 0xDEF...456

Database:
- FID: 12345 (same user!)
- Wallet 1: 0xABC...123 (Farcaster)
- Wallet 2: 0xDEF...456 (Base app) â† NEW
- Stack 1: "Summer Trip" (funded by 0xABC...123)
- Stack 2: "Emergency Fund" (funded by 0xDEF...456)


RESULT:
-------
âœ… Same FID (identity)
âœ… Multiple wallets
âœ… Each stack knows which wallet funds it
âœ… User sees ALL stacks in both apps (same FID)
âœ… But money comes from different wallets


================================================================================
SMART CONTRACT APPROVAL FLOW
================================================================================

FOR EACH STACK CREATED:
-----------------------

Step 1: User Creates Stack
- Choose name, amount, frequency
- Click "Create Stack"

Step 2: USDC Approval (if first time from this wallet)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "Approve USDC Spending"                  â”‚
â”‚                                          â”‚
â”‚ Stack needs permission to automatically  â”‚
â”‚ pull $10/week from:                      â”‚
â”‚ 0xABC...123                              â”‚
â”‚                                          â”‚
â”‚ [Approve in Wallet]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Transaction:
- Contract: USDC Token Contract
- Function: approve(stackContract, amount)
- Spender: Stack Contract Address
- Amount: Unlimited (or specific amount)

Step 3: Create Stack Transaction
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "Creating Stack"                         â”‚
â”‚                                          â”‚
â”‚ ğŸ–ï¸ Summer Trip                           â”‚
â”‚ $10/week from 0xABC...123                â”‚
â”‚                                          â”‚
â”‚ [Confirm in Wallet]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Transaction:
- Contract: Stack Contract
- Function: createStack(params)
- Params:
  * name: "Summer Trip"
  * amount: 10 USDC
  * frequency: weekly
  * wallet: 0xABC...123 â† Important!
  * fid: 12345


================================================================================
DATABASE SCHEMA (UPDATED)
================================================================================

Users Table:
- fid (PRIMARY KEY) - 12345
- username - "based_saver"
- pfp_url - "https://..."
- created_at

Wallets Table:
- id (PRIMARY KEY) - 1
- fid (FOREIGN KEY) - 12345
- address - "0xABC...123"
- chain_id - 8453 (Base)
- platform - "farcaster" | "base" | "web"
- is_primary - true
- created_at

- id (PRIMARY KEY) - 2
- fid (FOREIGN KEY) - 12345
- address - "0xDEF...456"
- chain_id - 8453 (Base)
- platform - "base"
- is_primary - false
- created_at

Stacks Table:
- id (PRIMARY KEY) - 1
- fid (FOREIGN KEY) - 12345
- wallet_address - "0xABC...123" â† Which wallet funds this
- name - "Summer Trip"
- amount_per_pull - 10
- frequency - "weekly"
- contract_address - "0xSTACK...001" â† On-chain stack contract
- status - "active"
- created_at

- id (PRIMARY KEY) - 2
- fid (FOREIGN KEY) - 12345
- wallet_address - "0xDEF...456" â† Different wallet!
- name - "Emergency Fund"
- amount_per_pull - 20
- frequency - "weekly"
- contract_address - "0xSTACK...002" â† Different stack contract
- status - "active"
- created_at


================================================================================
SMART CONTRACT ARCHITECTURE
================================================================================

OPTION 1: One Stack Contract Per User Stack
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Each time user creates a stack, deploy a new contract:

Contract: StackVault_001
- Owner: 0xABC...123
- Token: USDC
- Amount: 10 USDC
- Frequency: 7 days
- Automation: Chainlink Keeper pulls every 7 days

Pros:
âœ… Isolated funds per stack
âœ… Easy to break individual stacks
âœ… Clear ownership

Cons:
âŒ Gas cost to deploy each time
âŒ More contracts to manage


OPTION 2: One Master Contract, Multiple Vaults
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
One contract manages all stacks:

Contract: StackMaster
- Function: createVault(owner, amount, frequency)
- Vaults:
  * Vault 1: Owner 0xABC...123, $10/week
  * Vault 2: Owner 0xDEF...456, $20/week

Pros:
âœ… Lower gas (no deployment)
âœ… Centralized management
âœ… Easier upgrades

Cons:
âŒ More complex contract
âŒ Single point of failure


RECOMMENDED: Option 2 (Master Contract)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


================================================================================
APPROVAL REQUIREMENTS
================================================================================

WHEN USER CREATES FIRST STACK FROM A WALLET:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Approve USDC spending (one-time per wallet)
2. Create stack transaction

WHEN USER CREATES SECOND STACK FROM SAME WALLET:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Skip approval (already approved)
2. Just create stack transaction

WHEN USER CREATES STACK FROM DIFFERENT WALLET:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Approve USDC spending (first time for this wallet)
2. Create stack transaction


================================================================================
USER EXPERIENCE
================================================================================

CREATING STACK:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

UI Shows:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create Stack                            â”‚
â”‚                                         â”‚
â”‚ Name: Summer Trip                       â”‚
â”‚ Amount: $10/week                        â”‚
â”‚                                         â”‚
â”‚ Fund from:                              â”‚
â”‚ (â€¢) 0xABC...123 (Farcaster) â­          â”‚
â”‚     Balance: $500 USDC                  â”‚
â”‚                                         â”‚
â”‚ ( ) 0xDEF...456 (Base)                  â”‚
â”‚     Balance: $1,200 USDC                â”‚
â”‚                                         â”‚
â”‚ [+ Add Another Wallet]                  â”‚
â”‚                                         â”‚
â”‚ [Create Stack]                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User can:
- Choose which wallet to fund from
- See balance in each wallet
- Add more wallets
- Create stack


VIEWING ALL STACKS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Dashboard shows ALL stacks across ALL wallets:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Your Stacks                   2 Active  â”‚
â”‚                                         â”‚
â”‚ ğŸ–ï¸ Summer Trip                          â”‚
â”‚    $30/$120 â€¢ From 0xABC...123          â”‚
â”‚                                         â”‚
â”‚ ğŸš¨ Emergency Fund                       â”‚
â”‚    $60/$500 â€¢ From 0xDEF...456          â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User sees:
âœ… All stacks (same FID)
âœ… Which wallet funds each
âœ… Unified view across platforms


================================================================================
KEY TAKEAWAYS
================================================================================

1. FID = Identity (one per user)
2. Wallet = Money source (multiple per user)
3. Each stack is funded by ONE specific wallet
4. Each wallet needs USDC approval (one-time)
5. User can have stacks from different wallets
6. All stacks visible in both Farcaster and Base apps (same FID)
7. Smart contract pulls from the specific wallet that funds each stack

================================================================================
